<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Risk Simulator</title>
    <link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
			<button id="run-simulation" class="sidebar-btn" style="margin-bottom:18px;width:100%;font-size:1.1em;">Run Simulation</button>
			<div class="sidebar-section" id="sidebar-general">
				<h3>General Settings</h3>
				<label for="fund-return">Fund Return (%)</label>
				<input type="number" id="fund-return" step="1" required>
				<label for="tax-rate">Tax Rate (%)</label>
				<input type="number" id="tax-rate" step="1" min="0" max="100" required>
				<label for="expenses">Expenses (%)</label>
				<input type="number" id="expenses" step="1" min="0" max="100" required>
				<label for="profit">Profit (%)</label>
				<input type="number" id="profit" step="1" min="0" max="100" required>

			</div>
            <div class="sidebar-section" id="sidebar-strategy">
				<h3>Credit Strategy</h3>
				<select id="investment-strategy"></select>
				<div style="display:flex;gap:6px;margin-top:6px;">
					<button id="add-strategy" type="button" class="sidebar-btn" style="background:#6bbf7b;padding:4px 10px;font-size:0.95em;">Add</button>
					<button id="edit-strategy" type="button" class="sidebar-btn" style="background:#7183be;padding:4px 10px;font-size:0.95em;">Edit</button>
					<button id="delete-strategy" type="button" class="sidebar-btn" style="background:#b97a7a;padding:4px 10px;font-size:0.95em;">Delete</button>
				</div>
				<!-- Modal for strategy name input -->
				<!-- Create Modal: Only Name -->
				<div id="strategy-modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
					<div style="background:#232836;padding:32px 24px 24px 24px;border-radius:8px;box-shadow:0 2px 16px #000;width:340px;max-width:90vw;display:flex;flex-direction:column;align-items:stretch;">
						<h3 style="color:#fff;margin-top:0;">New Strategy</h3>
						<label for="modal-strategy-name" style="color:#b0b8d1;">Strategy Name</label>
						<input type="text" id="modal-strategy-name" style="margin-bottom:16px;padding:8px;border-radius:4px;border:1px solid #444a5a;background:#181c24;color:#e0e0e0;">
						<button id="modal-save-strategy" class="sidebar-btn" style="margin-bottom:8px;">Save</button>
						<button id="modal-cancel-strategy" class="sidebar-btn" style="background:#444a5a;">Cancel</button>
					</div>
				</div>
				<!-- Edit Modal: All Fields -->
				<div id="strategy-edit-modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
					<div style="background:#232836;padding:32px 24px 24px 24px;border-radius:8px;box-shadow:0 2px 16px #000;width:340px;max-width:90vw;display:flex;flex-direction:column;align-items:stretch;">
						<h3 style="color:#fff;margin-top:0;">Edit Strategy</h3>
						<label for="edit-strategy-name" style="color:#b0b8d1;">Strategy Name</label>
						<input type="text" id="edit-strategy-name" style="margin-bottom:12px;padding:8px;border-radius:4px;border:1px solid #444a5a;background:#181c24;color:#e0e0e0;">
						<label for="edit-strategy-reserve" style="color:#b0b8d1;">% Reserve Capital to Hold</label>
						<input type="number" id="edit-strategy-reserve" min="0" max="100" step="1" style="margin-bottom:12px;padding:8px;border-radius:4px;border:1px solid #444a5a;background:#181c24;color:#e0e0e0;" placeholder="e.g. 10">
						<label for="edit-strategy-reserve-rate" style="color:#b0b8d1;">Reserve Interest Rate (%)</label>
						<input type="number" id="edit-strategy-reserve-rate" step="1" style="margin-bottom:16px;padding:8px;border-radius:4px;border:1px solid #444a5a;background:#181c24;color:#e0e0e0;" placeholder="e.g. 2">
						<button id="edit-modal-save-strategy" class="sidebar-btn" style="margin-bottom:8px;">Save</button>
						<button id="edit-modal-cancel-strategy" class="sidebar-btn" style="background:#444a5a;">Cancel</button>
					</div>
				</div>
			</div>
			<div class="sidebar-section" id="sidebar-scenarios">
				<h3>Scenarios</h3>
				<select id="scenario-select"></select>
				<div style="display:flex;gap:6px;margin-top:6px;">
					<button id="add-scenario" type="button" class="sidebar-btn" style="background:#6bbf7b;padding:4px 10px;font-size:0.95em;">Add</button>
					<button id="edit-scenario" type="button" class="sidebar-btn" style="background:#7183be;padding:4px 10px;font-size:0.95em;">Edit</button>
					<button id="delete-scenario" type="button" class="sidebar-btn" style="background:#b97a7a;padding:4px 10px;font-size:0.95em;">Delete</button>
				</div>
				<!-- Modal for scenario name input -->
				<div id="scenario-modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
					<div style="background:#232836;padding:32px 24px 24px 24px;border-radius:8px;box-shadow:0 2px 16px #000;width:340px;max-width:90vw;display:flex;flex-direction:column;align-items:stretch;">
						<h3 style="color:#fff;margin-top:0;">New Scenario</h3>
						<!-- Remove scenario name input from new scenario modal -->
						<!-- <label for="modal-scenario-name" style="color:#b0b8d1;">Scenario Name</label> -->
						<!-- <input type="text" id="modal-scenario-name" style="margin-bottom:16px;padding:8px;border-radius:4px;border:1px solid #444a5a;background:#181c24;color:#e0e0e0;"> -->
						<label for="modal-scenario-date" style="color:#b0b8d1;">Date</label>
						<input type="date" id="modal-scenario-date" required style="margin-bottom:16px;padding:8px;border-radius:4px;border:1px solid #444a5a;background:#181c24;color:#e0e0e0;">
						<label for="modal-scenario-interest" style="color:#b0b8d1;">Interest Rate (%)</label>
						<input type="number" id="modal-scenario-interest" step="1" required style="margin-bottom:12px;padding:8px;border-radius:4px;border:1px solid #444a5a;background:#181c24;color:#e0e0e0;">
						<label for="modal-scenario-term" style="color:#b0b8d1;">Term (years)</label>
						<input type="number" id="modal-scenario-term" required style="margin-bottom:16px;padding:8px;border-radius:4px;border:1px solid #444a5a;background:#181c24;color:#e0e0e0;">
						<button id="modal-save-scenario" class="sidebar-btn" style="margin-bottom:8px;">Save</button>
						<button id="modal-cancel-scenario" class="sidebar-btn" style="background:#444a5a;">Cancel</button>
					</div>
				</div>
				<!-- Edit Modal: All Fields -->
				<div id="scenario-edit-modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
					<div style="background:#232836;padding:32px 24px 24px 24px;border-radius:8px;box-shadow:0 2px 16px #000;width:340px;max-width:90vw;display:flex;flex-direction:column;align-items:stretch;">
						<h3 style="color:#fff;margin-top:0;">Edit Scenario</h3>
						<!-- Remove scenario name input from edit scenario modal -->
						<!-- <label for="edit-scenario-name" style="color:#b0b8d1;">Scenario Name</label> -->
						<!-- <input type="text" id="edit-scenario-name" style="margin-bottom:12px;padding:8px;border-radius:4px;border:1px solid #444a5a;background:#181c24;color:#e0e0e0;"> -->
						<label for="edit-scenario-interest" style="color:#b0b8d1;">Interest Rate (%)</label>
						<input type="number" id="edit-scenario-interest" step="1" style="margin-bottom:12px;padding:8px;border-radius:4px;border:1px solid #444a5a;background:#181c24;color:#e0e0e0;">
						<label for="edit-scenario-term" style="color:#b0b8d1;">Term (years)</label>
						<input type="number" id="edit-scenario-term" style="margin-bottom:12px;padding:8px;border-radius:4px;border:1px solid #444a5a;background:#181c24;color:#e0e0e0;">
						<label for="edit-scenario-date" style="color:#b0b8d1;">Date</label>
						<input type="date" id="edit-scenario-date" required style="margin-bottom:12px;padding:8px;border-radius:4px;border:1px solid #444a5a;background:#181c24;color:#e0e0e0;">
						<button id="edit-modal-save-scenario" class="sidebar-btn" style="margin-bottom:8px;">Save</button>
						<button id="edit-modal-cancel-scenario" class="sidebar-btn" style="background:#444a5a;">Cancel</button>
					</div>
				</div>
			</div>
        </aside>
		<main class="main-area">
			<header>
				<!-- <h1>Credit Risk Simulator Dashboard</h1> -->
			</header>
			<section id="dashboard">
				<div id="dashboard-simulation-results" class="results"></div>
				<div class="dashboard-charts-scroll"><div id="dashboard-charts-container"></div></div>
			</section>
			<footer>
				<p>&copy; 2025 Credit Risk Simulator</p>
			</footer>
		</main>
    </div>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
		// Caching logic
		const cacheKeys = {
			fund_return: 'creditsimulator_fund_return',
			tax_rate: 'creditsimulator_tax_rate',
			expenses: 'creditsimulator_expenses',
			profit: 'creditsimulator_profit',
			strategy: 'creditsimulator_investment_strategy'
		};
		// Restore cached values
		const fundReturnInput = document.getElementById('fund-return');
		const taxRateInput = document.getElementById('tax-rate');
		const expensesInput = document.getElementById('expenses');
		const profitInput = document.getElementById('profit');
		if (localStorage.getItem(cacheKeys.fund_return)) {
			fundReturnInput.value = localStorage.getItem(cacheKeys.fund_return);
		} else {
			fundReturnInput.value = 30;
		}
		if (localStorage.getItem(cacheKeys.tax_rate)) {
			taxRateInput.value = localStorage.getItem(cacheKeys.tax_rate) || 0;
		}
		if (localStorage.getItem(cacheKeys.expenses)) {
			expensesInput.value = localStorage.getItem(cacheKeys.expenses) || 0;
		}
		if (localStorage.getItem(cacheKeys.profit)) {
			profitInput.value = localStorage.getItem(cacheKeys.profit) || 0;
		}
		// --- STRATEGY MANAGEMENT ---
		const STRATEGY_KEY = 'creditsimulator_strategies';
		const strategySelect = document.getElementById('investment-strategy');
		const addBtn = document.getElementById('add-strategy');
		const modal = document.getElementById('strategy-modal');
		const modalNameInput = document.getElementById('modal-strategy-name');
		const modalSave = document.getElementById('modal-save-strategy');
		const modalCancel = document.getElementById('modal-cancel-strategy');
		const editBtn = document.getElementById('edit-strategy');
		const deleteBtn = document.getElementById('delete-strategy');
		// Create modal
		const modalReserveInput = null;
		const modalReserveRateInput = null;
		// Edit modal
		const editModal = document.getElementById('strategy-edit-modal');
		const editModalName = document.getElementById('edit-strategy-name');
		const editModalReserve = document.getElementById('edit-strategy-reserve');
		const editModalReserveRate = document.getElementById('edit-strategy-reserve-rate');
		const editModalSave = document.getElementById('edit-modal-save-strategy');
		const editModalCancel = document.getElementById('edit-modal-cancel-strategy');
		let editingStrategy = null;

		function getStrategies() {
			const raw = localStorage.getItem(STRATEGY_KEY);
			if (!raw) return [
				{name:'Raw', reserve:0, reserveRate:0},
			];
			try { return JSON.parse(raw); } catch { return []; }
		}
		function saveStrategies(strats) {
			localStorage.setItem(STRATEGY_KEY, JSON.stringify(strats));
		}
		function refreshStrategyDropdown(selectedName) {
			const strats = getStrategies();
			strategySelect.innerHTML = strats.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
			if (selectedName && strats.some(s=>s.name===selectedName)) {
				strategySelect.value = selectedName;
			}
		}
		// Initial load
		refreshStrategyDropdown(localStorage.getItem(cacheKeys.strategy));
		// Restore cached selection
		if (localStorage.getItem(cacheKeys.strategy)) {
			strategySelect.value = localStorage.getItem(cacheKeys.strategy);
		}
		   // Save on change
		   const cacheInput = (id, key) => {
			   const el = document.getElementById(id);
			   if (el) {
				   el.addEventListener('input', e => {
					   localStorage.setItem(key, e.target.value);
				   });
			   }
		   };
		   cacheInput('fund-return', cacheKeys.fund_return);
		   cacheInput('tax-rate', cacheKeys.tax_rate);
		   cacheInput('expenses', cacheKeys.expenses);
		   cacheInput('profit', cacheKeys.profit);
		strategySelect.addEventListener('change', e => {
			localStorage.setItem(cacheKeys.strategy, e.target.value);
		});

		// Add strategy popup logic
		addBtn.addEventListener('click', function() {
			modal.style.display = 'flex';
			modalNameInput.value = '';
			setTimeout(()=>modalNameInput.focus(), 100);
		});
		modalCancel.addEventListener('click', function() {
			modal.style.display = 'none';
		});
		modalSave.addEventListener('click', function() {
			const name = modalNameInput.value.trim();
			if (!name) return;
			let strats = getStrategies();
			if (strats.some(s => s.name === name)) {
				alert('A strategy with this name already exists.');
				return;
			}
			// Default values for new strategies
			strats.push({name, growth: 5, reserve: 0, reserveRate: 0});
			saveStrategies(strats);
			refreshStrategyDropdown(name);
			strategySelect.value = name;
			localStorage.setItem(cacheKeys.strategy, name);
			modal.style.display = 'none';
		});
		modalNameInput.addEventListener('keydown', function(e) {
			if (e.key === 'Enter') {
				modalSave.click();
			}
		});

		// Edit strategy logic
		editBtn.addEventListener('click', function() {
			const strats = getStrategies();
			const selected = strategySelect.value;
			const strat = strats.find(s => s.name === selected);
			if (strat) {
				editingStrategy = strat.name;
				editModalName.value = strat.name;
				editModalReserve.value = strat.reserve ?? 0;
				editModalReserveRate.value = strat.reserveRate ?? 0;
				editModal.style.display = 'flex';
				setTimeout(()=>editModalName.focus(), 100);
			}
		});
		editModalCancel.addEventListener('click', function() {
			editModal.style.display = 'none';
			editingStrategy = null;
		});
		editModalSave.addEventListener('click', function() {
			const name = editModalName.value.trim();
			const reserve = parseFloat(editModalReserve.value);
			const reserveRate = parseFloat(editModalReserveRate.value);
			if (!name || isNaN(reserve) || isNaN(reserveRate)) return;
			let strats = getStrategies();
			// Prevent duplicate name (unless it's the same strategy)
			if (strats.some(s => s.name === name && s.name !== editingStrategy)) {
				alert('A strategy with this name already exists.');
				return;
			}
			strats = strats.map(s => s.name === editingStrategy ? {...s, name, reserve, reserveRate} : s);
			saveStrategies(strats);
			refreshStrategyDropdown(name);
			strategySelect.value = name;
			localStorage.setItem(cacheKeys.strategy, name);
			editModal.style.display = 'none';
			editingStrategy = null;
		});
		[editModalName, editModalReserve, editModalReserveRate].forEach(input => {
			input.addEventListener('keydown', function(e) {
				if (e.key === 'Enter') {
					editModalSave.click();
				}
			});
		});
		// Delete selected strategy
		deleteBtn.addEventListener('click', function() {
			let strats = getStrategies();
			const selected = strategySelect.value;
			if (!confirm('Delete strategy "' + selected + '"?')) return;
			strats = strats.filter(s => s.name !== selected);
			saveStrategies(strats);
			refreshStrategyDropdown();
			strategySelect.value = strats.length ? strats[0].name : '';
			localStorage.setItem(cacheKeys.strategy, strategySelect.value);
		});

		// --- SCENARIO MANAGEMENT ---
		const SCENARIO_KEY = 'creditsimulator_scenarios';
		const scenarioSelect = document.getElementById('scenario-select');
		const addScenarioBtn = document.getElementById('add-scenario');
		const editScenarioBtn = document.getElementById('edit-scenario');
		const deleteScenarioBtn = document.getElementById('delete-scenario');
		const scenarioModal = document.getElementById('scenario-modal');
		const scenarioModalSave = document.getElementById('modal-save-scenario');
		const scenarioModalInterest = document.getElementById('modal-scenario-interest');
		const scenarioModalTerm = document.getElementById('modal-scenario-term');
		const scenarioModalDate = document.getElementById('modal-scenario-date');
		const scenarioModalCancel = document.getElementById('modal-cancel-scenario');
		const editScenarioModal = document.getElementById('scenario-edit-modal');
		const editScenarioInterest = document.getElementById('edit-scenario-interest');
		const editScenarioTerm = document.getElementById('edit-scenario-term');
		const editScenarioModalSave = document.getElementById('edit-modal-save-scenario');
		const editScenarioModalCancel = document.getElementById('edit-modal-cancel-scenario');
		let editingScenario = null;

		function getScenarios() {
			const raw = localStorage.getItem(SCENARIO_KEY);
			if (!raw) return [];
			try { return JSON.parse(raw); } catch { return []; }
		}
		function saveScenarios(scenarios) {
			localStorage.setItem(SCENARIO_KEY, JSON.stringify(scenarios));
		}
		function refreshScenarioDropdown(selectedName) {
			const scenarios = getScenarios();
			scenarioSelect.innerHTML = scenarios.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
			if (selectedName && scenarios.some(s=>s.name===selectedName)) {
				scenarioSelect.value = selectedName;
			}
		}
		// Initial load
		refreshScenarioDropdown();
		// Add scenario
		addScenarioBtn.addEventListener('click', function() {
			scenarioModal.style.display = 'flex';
			document.getElementById('modal-scenario-date').value = '';
			setTimeout(()=>scenarioModalInterest.focus(), 100);
		});
		scenarioModalCancel.addEventListener('click', function() {
			scenarioModal.style.display = 'none';
		});
		scenarioModalSave.addEventListener('click', function() {
			// In add scenario logic, generate name from interest, term, and date
			const interest = parseFloat(document.getElementById('modal-scenario-interest').value);
			const term = parseInt(document.getElementById('modal-scenario-term').value);
			const date = document.getElementById('modal-scenario-date').value;
			if (isNaN(interest) || isNaN(term) || !date) {
				alert('Please enter interest, term, and date.');
				return;
			}
			const name = `${interest}% ${term}yr ${new Date(date + 'T00:00:00Z').toLocaleDateString('en-US', { timeZone: 'UTC' })}`;
			let scenarios = getScenarios();
			if (scenarios.some(s => s.name === name)) {
				alert('A scenario with these parameters already exists.');
				return;
			}
			// Default values for new scenario
			scenarios.push({name, interest, term, date});
			saveScenarios(scenarios);
			refreshScenarioDropdown(name);
			scenarioSelect.value = name;
			scenarioModal.style.display = 'none';
		});
		// Edit scenario
		editScenarioBtn.addEventListener('click', function() {
			const scenarios = getScenarios();
			const selected = scenarioSelect.value;
			const scenario = scenarios.find(s => s.name === selected);
			if (scenario) {
				editingScenario = scenario.name;
				editScenarioInterest.value = scenario.interest;
				editScenarioTerm.value = scenario.term;
				document.getElementById('edit-scenario-date').value = scenario.date || '';
				editScenarioModal.style.display = 'flex';
				setTimeout(()=>editScenarioInterest.focus(), 100);
			}
		});
		editScenarioModalCancel.addEventListener('click', function() {
			editScenarioModal.style.display = 'none';
			editingScenario = null;
		});
		editScenarioModalSave.addEventListener('click', function() {
			// In edit scenario logic, generate name from interest, term, and date
			const interest = parseFloat(editScenarioInterest.value);
			const term = parseInt(editScenarioTerm.value);
			const date = document.getElementById('edit-scenario-date').value;
			if (isNaN(interest) || isNaN(term) || !date) {
				alert('Please enter interest, term, and date.');
				return;
			}
			const name = `${interest}% ${term}yr ${new Date(date + 'T00:00:00Z').toLocaleDateString('en-US', { timeZone: 'UTC' })}`;
			let scenarios = getScenarios();
			// Prevent duplicate name (unless it's the same scenario)
			if (scenarios.some(s => s.name === name && s.name !== editingScenario)) {
				alert('A scenario with these parameters already exists.');
				return;
			}
			scenarios = scenarios.map(s => s.name === editingScenario ? {...s, name, interest, term, date} : s);
			saveScenarios(scenarios);
			refreshScenarioDropdown(name);
			scenarioSelect.value = name;
			editScenarioModal.style.display = 'none';
			editingScenario = null;
		});
		[editScenarioInterest, editScenarioTerm].forEach(input => {
			input.addEventListener('keydown', function(e) {
				if (e.key === 'Enter') {
					editScenarioModalSave.click();
				}
			});
		});

		// Delete selected scenario
		deleteScenarioBtn.addEventListener('click', function() {
			let scenarios = getScenarios();
			const selected = scenarioSelect.value;
			if (!selected) return;
			if (!confirm('Delete scenario "' + selected + '"?')) return;
			scenarios = scenarios.filter(s => s.name !== selected);
			saveScenarios(scenarios);
			refreshScenarioDropdown();
			if (scenarios.length) {
				scenarioSelect.value = scenarios[0].name;
			} else {
				scenarioSelect.value = '';
			}
		});

		document.getElementById('run-simulation').addEventListener('click', async function(e) {
			e.preventDefault();
			const strategyName = strategySelect.value;
			const strategies = getStrategies();
			const strategy = strategies.find(s => s.name === strategyName);
			const scenarios = getScenarios();
			if (!scenarios.length || !strategy) {
				alert('Please create at least one scenario and select a strategy.');
				return;
			}

			const loadSPYData = async () => {
				try {
					const response = await fetch('pricehistory/SPY.json');
					const spyData = await response.json();
					return spyData.map(c => ({ 
						...c, 
						date: c.date || new Date(c.datetime * 1000).toLocaleDateString('en-CA', {
							timeZone: 'America/New_York'
						})
					}));
				} catch (error) {
					console.error('Error loading SPY data:', error);
					throw error;
				}
			};

			// Generate compound interest data for the loan
			const generateCompoundInterestData = (principal, annualRate, years, basis = 365) => {
				const nDays = Math.round(years * basis);
				const dailyRate = Math.pow(1 + annualRate, 1 / basis) - 1;
				const dailyData = new Array(nDays + 1);
				for (let day = 0; day <= nDays; day++) {
					dailyData[day] = principal * Math.pow(1 + dailyRate, day);
				}
				return dailyData;
			};

			const amount = 10000;

			const fundReturn = parseFloat(document.getElementById('fund-return').value) / 100;
			const taxRate = parseFloat(document.getElementById('tax-rate').value) / 100;
			const expensesRate = parseFloat(document.getElementById('expenses').value) / 100;
			const profitRate = parseFloat(document.getElementById('profit').value) / 100;
			const totalCutRate = taxRate + expensesRate + profitRate;

			// Load SPY data once
			const spCandles = await loadSPYData();
			const spData = spCandles.map(c => c.close);

			// Chart container
			const chartsContainer = document.getElementById('dashboard-charts-container');
			chartsContainer.innerHTML = '';
			const resultsDiv = document.getElementById('dashboard-simulation-results');
			resultsDiv.innerHTML = '';

			// Store chart instances to destroy later if needed
			if (!window.dashboardCharts) window.dashboardCharts = [];
			window.dashboardCharts.forEach(chart => chart.destroy());
			window.dashboardCharts = [];

			// For each scenario, run simulation and create chart
			for (const scenario of scenarios) {
				const interestRate = scenario.interest / 100;
				const term = scenario.term;
				const compoundInterestData = generateCompoundInterestData(amount, interestRate, term);

				// Generate a new compound curve that follows fundReturn but includes the market drawdown pattern
				function adjustToTargetCAGR(spData, amount, targetCagr, basis = 252, volScale = 1) {
					if (!spData || spData.length < 2) return [];
					const n = spData.length;
					const p0 = spData[0];
					const yearsTotal = (n - 1) / basis;
					const spyCagr = Math.pow(spData[n - 1] / p0, 1 / yearsTotal) - 1;
					const spySlope = Math.log(1 + spyCagr);
					const tgtSlope = Math.log(1 + targetCagr);
					const out = new Array(n);
					for (let i = 0; i < n; i++) {
						const tYears = i / basis;
						const logRel = Math.log(spData[i] / p0);
						const shape = Math.exp((logRel - spySlope * tYears) * volScale);
						out[i] = amount * Math.exp(tgtSlope * tYears) * shape;
					}
					return out;
				}

				// Find the index in spCandles that matches the scenario's date
				const scenarioStartIdx = spCandles.findIndex(c => c.date === scenario.date);
				if (scenarioStartIdx === -1) {
					// Show error for this scenario
					const errorDiv = document.createElement('div');
					errorDiv.style.color = 'red';
					errorDiv.textContent = `No SPY data available for scenario: ${scenario.name}`;
					chartsContainer.appendChild(errorDiv);
					continue;
				}
				// Slice the SPY and compound data to start at the scenario date
				const spCandlesOffset = spCandles.slice(scenarioStartIdx);
				const spDataOffset = spData.slice(scenarioStartIdx);
				const compoundInterestDataOffset = compoundInterestData.slice(0, spDataOffset.length);

				// Blended S&P + Reserve compounding
				let spNormalizedOffset;
				const reservePct = (typeof strategy.reserve === 'number' ? strategy.reserve : 0) / 100;
				const reserveRate = (typeof strategy.reserveRate === 'number' ? strategy.reserveRate : 0) / 100;
				if (reservePct > 0) {
					// S&P portion
					const spPortion = adjustToTargetCAGR(spDataOffset, amount * (1 - reservePct), fundReturn, 252, 1);
					// Reserve portion: compound at reserveRate, or flat if 0
					let reservePortion;
					if (reserveRate > 0) {
						reservePortion = [];
						const n = spDataOffset.length;
						for (let i = 0; i < n; i++) {
							reservePortion[i] = amount * reservePct * Math.pow(1 + reserveRate / 252, i); // daily compounding
						}
					} else {
						reservePortion = Array(spDataOffset.length).fill(amount * reservePct);
					}
					// Sum both portions
					spNormalizedOffset = spPortion.map((v, i) => v + reservePortion[i]);
				} else {
					spNormalizedOffset = adjustToTargetCAGR(spDataOffset, amount, fundReturn, 252, 1);
				}

				// Calculate Net Performance: subtract the compound curve using the cut rate from the S&P performance
				// 1. Generate a compound curve using the cut rate
				const compoundWithCut = generateCompoundInterestData(amount, totalCutRate, term).slice(0, spNormalizedOffset.length);
				// 2. Net performance is S&P minus the cut curve
				const netPerformance = spNormalizedOffset.map((v, i) => amount + v - compoundWithCut[i]);

				// Results summary for each scenario (now using Net Performance)
				const finalCompound = compoundInterestDataOffset[compoundInterestDataOffset.length - 1];
				const finalNet = netPerformance[compoundInterestDataOffset.length - 1];
				const outperformancePercent = ((finalNet - finalCompound) / finalCompound * 100).toFixed(2);

				// Calculate underwater statistics (using Net Performance)
				let underwaterDays = 0;
				let maxDrawdown = 0;
				for (let i = 0; i < compoundInterestDataOffset.length; i++) {
					const compound = compoundInterestDataOffset[i];
					const net = netPerformance[i];
					if (net < compound) {
						underwaterDays++;
						const drawdown = (compound - net) / compound * 100;
						if (drawdown > maxDrawdown) {
							maxDrawdown = drawdown;
						}
					}
				}
				const underwaterPercent = (underwaterDays / compoundInterestDataOffset.length * 100).toFixed(1);

				const scenarioResultDiv = document.createElement('div');
				scenarioResultDiv.className = 'scenario-result';
				scenarioResultDiv.style.marginBottom = '8px';
				scenarioResultDiv.style.padding = '6px 10px';
				scenarioResultDiv.style.border = '1px solid #444a5a';
				scenarioResultDiv.style.borderRadius = '5px';
				scenarioResultDiv.style.background = '#232836';
				scenarioResultDiv.innerHTML = `
					<div style="font-weight:bold;margin-bottom:4px;color:#fff;font-size:1.04em;">${scenario.name}</div>
					<div style="color:#b0b8d1;line-height:1.2;font-size:0.98em;">
						Final vs Compound: <span style="color:${outperformancePercent >= 0 ? '#6bbf7b' : '#b97a7a'};font-weight:bold;">${outperformancePercent >= 0 ? '+' : ''}${outperformancePercent}%</span>
						&nbsp;|&nbsp; Underwater: <span style="color:#e0e0e0;">${underwaterPercent}%</span>
						&nbsp;|&nbsp; Max Drawdown: <span style="color:#b97a7a;">${maxDrawdown.toFixed(2)}%</span>
					</div>
				`;
				resultsDiv.appendChild(scenarioResultDiv);

				// Create a wrapper for each chart and its stats
				const chartWrapper = document.createElement('div');
				chartWrapper.className = 'scenario-chart-wrapper';
				chartWrapper.style.marginBottom = '32px';

				// Scenario stats summary
				const statsDiv = document.createElement('div');
				statsDiv.className = 'scenario-stats';
				statsDiv.style.marginBottom = '12px';
				statsDiv.style.fontSize = '1.08em';
				statsDiv.style.color = '#b0b8d1';
				statsDiv.innerHTML = `
					Interest: <b>${scenario.interest}%</b> &nbsp;|
					Term: <b>${scenario.term} yr</b> &nbsp;|
					Start Date: <b>${scenario.date}</b>
				`;
				chartWrapper.appendChild(statsDiv);

				// Chart canvas
				const canvas = document.createElement('canvas');
				canvas.width = 1200;
				canvas.height = 800;
				chartWrapper.appendChild(canvas);
				chartsContainer.appendChild(chartWrapper);

				const ctx = canvas.getContext('2d');
				const chart = new Chart(ctx, {
					type: 'line',
					data: {
						labels: compoundInterestDataOffset.map((_, i) => {
							const date = new Date(spCandlesOffset[i]?.date);
							return date.toLocaleDateString();
						}),
						datasets: [
							{
								label: 'Compound Interest',
								data: compoundInterestDataOffset,
								borderColor: 'rgba(75,192,192,1)',
								fill: false,
								pointRadius: 0
							},
							{
								label: 'S&P 500 Adjusted',
								data: spNormalizedOffset.slice(0, compoundInterestDataOffset.length),
								borderColor: 'rgba(153,102,255,1)',
								fill: false,
								pointRadius: 0
							},
							{
								label: 'Net Performance',
								data: netPerformance.slice(0, compoundInterestDataOffset.length),
								borderColor: 'rgba(107,191,123,1)',
								fill: false,
								pointRadius: 0
							}
						]
					},
					options: {
						responsive: false,
						layout: { padding: 24 },
						plugins: {
							legend: {
								position: 'top',
								labels: { color: '#b0b8d1' }
							},
							title: {
								display: false,
								color: '#b0b8d1'
							},
							tooltip: {
								bodyColor: '#b0b8d1',
								titleColor: '#b0b8d1',
								footerColor: '#b0b8d1'
							}
						},
						scales: {
							y: {
								beginAtZero: true,
								ticks: { color: '#b0b8d1' },
								grid: { color: 'rgba(176,184,209,0.10)' }
							},
							x: {
								ticks: {
									maxTicksLimit: 10,
									color: '#b0b8d1'
								},
								grid: { color: 'rgba(176,184,209,0.15)' }
							}
						}
					}
				});
				window.dashboardCharts.push(chart);
			}
		});
	</script>
</body>
</html>